name: Build the docker image

on: 
    workflow_call:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v2

            - name: Install Nix
              uses: cachix/install-nix-action@v15
              with:
                extra_nix_config: |
                  experimental-features = nix-command flakes

            - name: Ensure the existance of /nix/store for cache restoration
              run: |
                sudo mkdir -p /nix/store
                sudo chmod -R 777 /nix

            - name: Cache Nix Store
              uses: actions/cache@v2
              with:
                key: nix-store-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}
                restore-keys: |
                  nix-store-${{ runner.os }}-
                path: |
                  # See https://github.com/actions/cache/pull/726
                  # from https://github.com/cachix/install-nix-action/issues/56
                  /nix/store/**
                  # Missing something?
                  /nix/var/nix/*/*
                  /nix/var/nix/db/*
                  /nix/var/nix/db/*/**
                  !/nix/var/nix/daemon-socket/socket
                  !/nix/var/nix/userpool/*
                  !/nix/var/nix/gc.lock
                  !/nix/var/nix/db/big-lock
                  !/nix/var/nix/db/reserved

            - name: Build flake
              run: nix build .

            - name: Save docker image as a tarball
              run: |
                docker load < result
                docker save -o image.tar rosenpass

            - name: Upload docker image
              uses: actions/upload-artifact@v2
              with:
                name: rosenpass
                path: image.tar